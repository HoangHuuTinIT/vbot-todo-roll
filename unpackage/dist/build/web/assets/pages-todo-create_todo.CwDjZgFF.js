import{U as e,T as t,u as a,a as o,r as s,x as l,c as n,p as r,g as c,K as i,f as u,i as d,j as m,w as g,A as p,C as f,k as h,t as v,l as _,O as C,m as y,N as b,V as k}from"./index-QVVW7vKj.js";import{_ as D,T as U,a as A}from"./TodoDatePicker.za20Lb_h.js";import{T as w,s as S,i as $,v as I,j as M,k as L,l as N,c as T,m as E,A as O,e as j,G as x,f as F,_ as P}from"./GlobalNotification.BhdNdCXS.js";import{u as R,C as V}from"./useCustomerFilter.BsmAzfrt.js";const G=e=>{if(!e)return 0;const t=e.replace(/-/g,"/"),a=new Date(t);return isNaN(a.getTime())?0:a.getTime()},B=()=>{const{t:u}=a(),d=o(),m=e=>e.toString().padStart(2,"0"),{customerList:g,loadingCustomer:p,loadingMore:f,fetchCustomers:h,loadMoreCustomers:v}=R(),_=s(!1),C=s({name:"",desc:"",customer:"",customerUid:"",assignee:"",dueDate:"",notifyAt:""});l((()=>C.value.dueDate),(e=>{})),l((()=>C.value.notifyAt),(e=>{}));const y=n((()=>[u("source.call"),u("source.customer"),u("source.conversation")])),b=[t.CALL,t.CUSTOMER,t.CONVERSATION],k=s(-1),D=s([]),U=s([]),A=s(-1),O=s(!1);s("");const j=n((()=>A.value>-1&&U.value.length>0?U.value[A.value]:""));return r((()=>{(async()=>{try{const e=await c();D.value=e,U.value=e.map((e=>e.UserName||u("common.unknown_member")))}catch(e){console.error("Lỗi lấy thành viên:",e),S(u("todo.error_load_member"))}})(),h({}),setTimeout((()=>{const e=(()=>{const e=new Date;return`${e.getFullYear()}-${m(e.getMonth()+1)}-${m(e.getDate())} ${m(e.getHours())}:${m(e.getMinutes())}:00`})();C.value.dueDate=e,C.value.notifyAt=e}),100)})),{loading:_,form:C,memberOptions:U,onMemberChange:e=>{const t=e.detail.value;A.value=t;const a=D.value[t];a&&(C.value.assignee=a.memberUID)},currentAssigneeName:j,showCustomerModal:O,loadingCustomer:p,customerList:g,openCustomerPopup:()=>{O.value=!0,0===g.value.length&&h({})},onCustomerSelect:e=>{if(C.value.customer=`${e.name} - ${e.phone}`,C.value.customerUid=e.uid,e.managerUid){const t=D.value.findIndex((t=>t.memberUID===e.managerUid));-1!==t&&(A.value=t,C.value.assignee=e.managerUid,console.log(`Đã tự động chọn quản lý: ${D.value[t].UserName}`))}O.value=!1},goBack:()=>i(),submitForm:async()=>{if(!C.value.name||!C.value.name.trim())return void $(u("todo.validate_name"));if(!I(C.value.dueDate,C.value.notifyAt))return void S(u("todo.msg_notify_must_be_before_due"));let a="CALL";k.value>=0&&(a=b[k.value]),_.value=!0,M(u("todo.upload_processing"));try{const{newContent:o,fileUrls:s}=await(async e=>{if(!e)return{newContent:"",fileUrls:[]};const t=/<img[^>]+src="([^">]+)"/g;let a;const o=[],s=[],l=[];for(;null!==(a=t.exec(e));){const e=a[1];if(!e.startsWith("http")&&!e.startsWith("https")){const t=E(e).then((t=>{s.push({oldSrc:e,newSrc:t}),l.push(t)})).catch((t=>{console.error(`Upload ảnh ${e} lỗi:`,t)}));o.push(t)}}o.length>0&&await Promise.all(o);let n=e;return s.forEach((e=>{n=n.split(e.oldSrc).join(e.newSrc)})),{newContent:n,fileUrls:l}})(C.value.desc);C.value.desc=o;const l=((a,o)=>(console.log("Check date values:",{dueDate:a.dueDate,notifyAt:a.notifyAt}),{title:a.name,description:a.desc||e.STRING,projectCode:o.projectCode,createdBy:o.uid,status:w.NEW,links:o.link||t.CALL,pluginType:e.PLUGIN_TYPE,customerCode:a.customerUid||e.CUSTOMER_CODE,assigneeId:a.assignee||e.ASSIGNEE_ID,groupId:e.GROUP_ID,transId:e.TRANS_ID,tagCodes:"test1",groupMemberUid:"test1",files:o.uploadedFiles||e.STRING,phone:e.PHONE_PLACEHOLDER,dueDate:G(a.dueDate),notificationReceivedAt:G(a.notifyAt)}))(C.value,{projectCode:d.projectCode,uid:d.uid,link:a,uploadedFiles:s.length>0?s[0]:""});console.log("Payload Submit:",l),await L(l),N(),T(u("todo.create_success")),setTimeout((()=>{i()}),1500)}catch(o){N(),console.error("Create Error:",o);const e=(null==o?void 0:o.message)||("string"==typeof o?o:u("common.failed"));S(u("common.error_load")+": "+e)}finally{_.value=!1}},sourceOptions:y,sourceIndex:k,onSourceChange:e=>{k.value=parseInt(e.detail.value)},memberList:D,onCustomerFilter:e=>{h(e)},loadingMore:f,loadMoreCustomers:v}},H=P(u({__name:"create_todo",setup(e){const t=o(),a=n((()=>t.isDark)),{loading:s,form:l,goBack:r,submitForm:c,memberOptions:i,onMemberChange:u,currentAssigneeName:w,showCustomerModal:S,loadingCustomer:$,customerList:I,openCustomerPopup:M,onCustomerSelect:L,sourceOptions:N,sourceIndex:T,onSourceChange:E,memberList:P,onCustomerFilter:R,loadingMore:G,loadMoreCustomers:H}=B(),W=n((()=>{if(!l.value.assignee||!P.value.length)return 0;const e=P.value.findIndex((e=>e.memberUID===l.value.assignee));return-1!==e?e:0}));return(e,t)=>{const o=C,n=y,B=b,Y=k;return d(),m(n,{class:_(["container",{"theme-dark":a.value}])},{default:g((()=>[p(n,{class:"custom-header"},{default:g((()=>[p(n,{onClick:f(r),class:"back-btn"},{default:g((()=>[p(o,{src:D,class:"back-icon"})])),_:1},8,["onClick"]),p(B,{class:"header-title"},{default:g((()=>[h(v(e.$t("todo.create_page_title")),1)])),_:1}),p(n,{class:"header-right"})])),_:1}),p(n,{class:"content-body"},{default:g((()=>[p(n,{class:"flat-item title-input-group"},{default:g((()=>[p(n,{class:"item-left"},{default:g((()=>[p(o,{src:"https://img.icons8.com/ios/50/666666/edit--v1.png",class:"item-icon"})])),_:1}),p(Y,{class:"item-input title-textarea",modelValue:f(l).name,"onUpdate:modelValue":t[0]||(t[0]=e=>f(l).name=e),placeholder:e.$t("todo.enter_task_name"),maxlength:"256","auto-height":"","placeholder-class":"input-placeholder"},null,8,["modelValue","placeholder"]),p(B,{class:"char-count"},{default:g((()=>[h(v(e.$t("todo.char_count").replace("{current}",String(f(l).name?f(l).name.length:0)).replace("{max}","256")),1)])),_:1})])),_:1}),p(U,{modelValue:f(l).desc,"onUpdate:modelValue":t[1]||(t[1]=e=>f(l).desc=e),placeholder:e.$t("editor.placeholder")},null,8,["modelValue","placeholder"]),p(n,{class:"flat-item",onClick:f(M)},{default:g((()=>[p(n,{class:"item-left"},{default:g((()=>[p(o,{src:"https://img.icons8.com/ios/50/666666/price-tag.png",class:"item-icon"})])),_:1}),p(n,{class:_(["input-trigger",{placeholder:!f(l).customer}])},{default:g((()=>[h(v(f(l).customer||e.$t("todo.select_customer")),1)])),_:1},8,["class"]),p(B,{class:"arrow-icon"},{default:g((()=>[h("›")])),_:1})])),_:1},8,["onClick"]),p(V,{visible:f(S),loading:f($),loadingMore:f(G),customers:f(I),managers:f(P),onClose:t[2]||(t[2]=e=>S.value=!1),onSelect:f(L),onFilter:f(R),onLoadMore:f(H)},null,8,["visible","loading","loadingMore","customers","managers","onSelect","onFilter","onLoadMore"]),p(n,{class:"flat-item"},{default:g((()=>[p(n,{class:"item-left"},{default:g((()=>[p(o,{src:"https://img.icons8.com/ios/50/666666/internet.png",class:"item-icon"})])),_:1}),p(O,{range:f(N),value:f(T)>-1?f(T):0,onChange:f(E),class:"full-width-picker",title:e.$t("todo.source")},{default:g((()=>[p(n,{class:_(["picker-display",{"placeholder-color":-1===f(T)}])},{default:g((()=>[h(v(f(T)>-1?f(N)[f(T)]:e.$t("todo.select_source")),1)])),_:1},8,["class"])])),_:1},8,["range","value","onChange","title"]),p(B,{class:"arrow-icon"},{default:g((()=>[h("›")])),_:1})])),_:1}),p(n,{class:"flat-item"},{default:g((()=>[p(n,{class:"item-left"},{default:g((()=>[p(o,{src:"https://img.icons8.com/ios/50/666666/user.png",class:"item-icon"})])),_:1}),p(O,{range:f(i),value:W.value,onChange:f(u),class:"full-width-picker",title:e.$t("todo.assignee")},{default:g((()=>[p(n,{class:_(["picker-display",{"placeholder-color":!f(w)}])},{default:g((()=>[h(v(f(w)?f(w):e.$t("todo.assignee")),1)])),_:1},8,["class"])])),_:1},8,["range","value","onChange","title"]),p(B,{class:"arrow-icon"},{default:g((()=>[h("›")])),_:1})])),_:1}),p(A,{class:_({"theme-dark":a.value}),dueDate:f(l).dueDate,"onUpdate:dueDate":t[3]||(t[3]=e=>f(l).dueDate=e),notifyAt:f(l).notifyAt,"onUpdate:notifyAt":t[4]||(t[4]=e=>f(l).notifyAt=e)},null,8,["class","dueDate","notifyAt"]),p(n,{class:"footer-action"},{default:g((()=>[p(n,{style:{width:"35%"}},{default:g((()=>[p(j,{type:"secondary",label:e.$t("common.cancel_action"),onClick:f(r)},null,8,["label","onClick"])])),_:1}),p(n,{style:{width:"60%"}},{default:g((()=>[p(j,{type:"primary",label:f(s)?e.$t("common.saving"):e.$t("common.save"),loading:f(s),onClick:f(c)},null,8,["label","loading","onClick"])])),_:1})])),_:1})])),_:1}),p(x),p(F)])),_:1},8,["class"])}}}),[["__scopeId","data-v-4217af84"]]);export{H as default};
