import{U as e,T as a,u as t,a as o,r as s,x as l,c as n,b as r,i,V as c,j as u,k as d,l as m,w as A,A as g,C as p,m as f,t as C,n as h,O as v,p as I,N as _,W as S}from"./index-BZqgQir-.js";import{_ as k,T as U,a as w,b as E,c as y}from"./TodoDatePicker.DEcGnRZm.js";import{T as D,s as M,i as T,j as b,v as N,k as R,l as O,m as L,c as P,o as B,A as x,e as V,G as q,f as F,_ as G}from"./GlobalNotification.DhNo57xC.js";import{u as W,C as Y}from"./useCustomerFilter.CrmD1KB_.js";const j=e=>{if(!e)return 0;const a=e.replace(/-/g,"/"),t=new Date(a);return isNaN(t.getTime())?0:t.getTime()},K=()=>{const{t:u}=t(),d=o(),m=e=>e.toString().padStart(2,"0"),{customerList:A,loadingCustomer:g,loadingMore:p,fetchCustomers:f,loadMoreCustomers:C}=W(),h=s(!1),v=s({name:"",desc:"",customer:"",customerUid:"",assignee:"",dueDate:"",notifyAt:""});l((()=>v.value.dueDate),(e=>{})),l((()=>v.value.notifyAt),(e=>{}));const I=n((()=>[u("source.call"),u("source.customer"),u("source.conversation")])),_=[a.CALL,a.CUSTOMER,a.CONVERSATION],S=s(-1),k=s([]),U=s([]),w=s(-1),E=s(!1);s("");const y=n((()=>w.value>-1&&U.value.length>0?U.value[w.value]:""));return r((()=>{(async()=>{try{const e=await i();k.value=e,U.value=e.map((e=>e.UserName||u("common.unknown_member")))}catch(e){console.error("Lỗi lấy thành viên:",e),M(u("todo.error_load_member"))}})(),f({}),setTimeout((()=>{const e=(()=>{const e=new Date;return`${e.getFullYear()}-${m(e.getMonth()+1)}-${m(e.getDate())} ${m(e.getHours())}:${m(e.getMinutes())}:00`})();v.value.dueDate=e,v.value.notifyAt=e}),100)})),{loading:h,form:v,memberOptions:U,onMemberChange:e=>{const a=e.detail.value;w.value=a;const t=k.value[a];t&&(v.value.assignee=t.memberUID)},currentAssigneeName:y,showCustomerModal:E,loadingCustomer:g,customerList:A,openCustomerPopup:()=>{E.value=!0,0===A.value.length&&f({})},onCustomerSelect:e=>{if(v.value.customer=`${e.name} - ${e.phone}`,v.value.customerUid=e.uid,e.managerUid){const a=k.value.findIndex((a=>a.memberUID===e.managerUid));-1!==a&&(w.value=a,v.value.assignee=e.managerUid,console.log(`Đã tự động chọn quản lý: ${k.value[a].UserName}`))}E.value=!1},goBack:()=>T(),submitForm:async()=>{if(!v.value.name||!v.value.name.trim())return void b(u("todo.validate_name"));if(!N(v.value.dueDate,v.value.notifyAt))return void M(u("todo.msg_notify_must_be_before_due"));let t="CALL";S.value>=0&&(t=_[S.value]),h.value=!0,R(u("todo.upload_processing"));try{const{newContent:o,fileUrls:s}=await(async e=>{if(!e)return{newContent:"",fileUrls:[]};const a=/<img[^>]+src="([^">]+)"/g;let t;const o=[],s=[],l=[];for(;null!==(t=a.exec(e));){const e=t[1];if(!e.startsWith("http")&&!e.startsWith("https")){const a=B(e).then((a=>{s.push({oldSrc:e,newSrc:a}),l.push(a)})).catch((a=>{console.error(`Upload ảnh ${e} lỗi:`,a)}));o.push(a)}}o.length>0&&await Promise.all(o);let n=e;return s.forEach((e=>{n=n.split(e.oldSrc).join(e.newSrc)})),{newContent:n,fileUrls:l}})(v.value.desc);v.value.desc=o;const l=((t,o)=>(console.log("Check date values:",{dueDate:t.dueDate,notifyAt:t.notifyAt}),{title:t.name,description:t.desc||e.STRING,projectCode:o.projectCode,createdBy:o.uid,status:D.NEW,links:o.link||a.CALL,pluginType:e.PLUGIN_TYPE,customerCode:t.customerUid||e.CUSTOMER_CODE,assigneeId:t.assignee||e.ASSIGNEE_ID,groupId:e.GROUP_ID,transId:e.TRANS_ID,tagCodes:"test1",groupMemberUid:"test1",files:o.uploadedFiles||e.STRING,phone:e.PHONE_PLACEHOLDER,dueDate:j(t.dueDate),notificationReceivedAt:j(t.notifyAt)}))(v.value,{projectCode:d.projectCode,uid:d.uid,link:t,uploadedFiles:s.length>0?s[0]:""});console.log("Payload Submit:",l),await O(l),L(),P(u("todo.create_success")),c("refresh-todo-list",{type:"create"}),setTimeout((()=>{T()}),1500)}catch(o){L(),console.error("Create Error:",o);const e=(null==o?void 0:o.message)||("string"==typeof o?o:u("common.failed"));M(u("common.error_load")+": "+e)}finally{h.value=!1}},sourceOptions:I,sourceIndex:S,onSourceChange:e=>{S.value=parseInt(e.detail.value)},memberList:k,onCustomerFilter:e=>{f(e)},loadingMore:p,loadMoreCustomers:C}},z=G(u({__name:"create_todo",setup(e){const a=o(),t=n((()=>a.isDark)),{loading:s,form:l,goBack:r,submitForm:i,memberOptions:c,onMemberChange:u,currentAssigneeName:D,showCustomerModal:M,loadingCustomer:T,customerList:b,openCustomerPopup:N,onCustomerSelect:R,sourceOptions:O,sourceIndex:L,onSourceChange:P,memberList:B,onCustomerFilter:G,loadingMore:W,loadMoreCustomers:j}=K(),z=n((()=>{if(!l.value.assignee||!B.value.length)return 0;const e=B.value.findIndex((e=>e.memberUID===l.value.assignee));return-1!==e?e:0}));return(e,a)=>{const o=v,n=I,K=_,Q=S;return d(),m(n,{class:h(["container",{"theme-dark":t.value}])},{default:A((()=>[g(n,{class:"custom-header"},{default:A((()=>[g(n,{onClick:p(r),class:"back-btn"},{default:A((()=>[g(o,{src:k,class:"back-icon"})])),_:1},8,["onClick"]),g(K,{class:"header-title"},{default:A((()=>[f(C(e.$t("todo.create_page_title")),1)])),_:1}),g(n,{class:"header-right"})])),_:1}),g(n,{class:"content-body"},{default:A((()=>[g(n,{class:"flat-item title-input-group"},{default:A((()=>[g(n,{class:"item-left"},{default:A((()=>[g(o,{src:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADIAAAAyCAYAAAAeP4ixAAAACXBIWXMAAAsTAAALEwEAmpwYAAABhUlEQVR4nO3ZvUoDQRSG4VPYamHpZQj2Wot2Ymd0s987/hBIZ5lr0EuwtvECbCxsxNI7MI2VNiqCUQY2sMYkJjY5E+aFJZBsMQ9MTsKOWS43VZLWgCvgWdKrpFtg11IKaAAfwNfgJencUqjT6SxIuhuGqF07lkLNZnMZuB8DuTGvlWUpoAts/IWR9GIeAw6BXrXQzf77YzBP5hzRHvx8BObSUkKMwMRptmqpIeqYapo1LEUEsBVCWO+PZvOSpDAFol3d1zVP/RPRAzAvAaWkz2pxp1MgTsxLc4EIITQzwkMZkTpC0rF5KSO8NBcISUVGeEgZ4SRlhJOUEYkjgCPzkjLCSZoHBHCQER4qy3K/hpjo4Vm8P/6FNy+1Wq0l4C1pREzSdm2bHNpk22nkfTMLOKsdogxdpHtETNLDwInQj8UmgSiKYqX2hPwXJglELISwN+oYuD/F4mv8kTTPARfjDuclvcfRbN6T9Dhk8Q/VANgqimLRUgi4rjAXcZvF78ys15SzhPsGc13jc1wqjCcAAAAASUVORK5CYII=",class:"item-icon"})])),_:1}),g(Q,{class:"item-input title-textarea",modelValue:p(l).name,"onUpdate:modelValue":a[0]||(a[0]=e=>p(l).name=e),placeholder:e.$t("todo.enter_task_name"),maxlength:"256","auto-height":"","placeholder-class":"input-placeholder"},null,8,["modelValue","placeholder"]),g(K,{class:"char-count"},{default:A((()=>[f(C(e.$t("todo.char_count",{current:p(l).name?p(l).name.length:0,max:256})),1)])),_:1})])),_:1}),g(U,{modelValue:p(l).desc,"onUpdate:modelValue":a[1]||(a[1]=e=>p(l).desc=e),placeholder:e.$t("editor.placeholder")},null,8,["modelValue","placeholder"]),g(n,{class:"flat-item customer-item",onClick:p(N)},{default:A((()=>[g(n,{class:"item-left"},{default:A((()=>[g(o,{src:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADIAAAAyCAYAAAAeP4ixAAAACXBIWXMAAAsTAAALEwEAmpwYAAACUElEQVR4nO3ZMW/UMBQHcAshBpZeCwMSIHUAJGa+BfuxRsJ+f8t3SHRky9dAfALKqRPlO7SlwMjQgQFGKmiHqgxw1dO9q470TroktmOr/UteTsm7/OLYcRKlrnIJA+A2gDcAvgP4B2Dcov0BsGetfRoVYYy5B+Cg5cGP57VomArikzHmSVmW19vU7Pf7NwC84ppEtKtiI7TWa75q9ycYhpyqiIgvw+Hwlu//gFxeKlZPOOdW6+5PRCMAx9yIaMta+zAqpILYb4IAcDhnYB9aa+9GgbRFcGjSE7z/ez5wbgC25bfN4BAfCDm4Y5lWz8++c+6+1P0dFOILwSGiI67DNaNCfCI4RLQltba5tgz8DzLVjoJAZhFE9LEtQmo+IqKf8wa71vqBd0gIxDR2MsA3+TKTNqoivEAqiM8+79h10gqSCqIVJOTaKRrEJIZoBEkRURtSQewVRdFTCaQsy2syTv9m2xMcADcFcqJqzE67qfTENFrrx3JsP1TGiDW+QuRKeb0UAsCKShdxwG9nLmw0GAzuzIyJndQQzrnVWcTsCvm/AHiXPYLD6/3qs0BCiP2lEBwAX2VsDFSuCI4x5tn0JkNEz1WOiGkAbMi7WW5OdZSiKHq8kpAT+81au167SNeYoih6MvU3R3SNAbDiDTEPE2MCCIKIjQmKiIWJggiNiYoIhekE4RvTKcIXhhGyMO0OseA+M1Q5IppikkTUxSSNWBaTBWLBBPAiS0QFMxbMS/nStNPoeSKhnjn/SJNNTyx40uTH5l9E9JbfzlzY6CqXIGdeAVlOOaDiuAAAAABJRU5ErkJggg==",class:"item-icon"})])),_:1}),g(n,{class:h(["input-trigger",{placeholder:!p(l).customer}])},{default:A((()=>[f(C(p(l).customer||e.$t("todo.select_customer")),1)])),_:1},8,["class"]),g(K,{class:"arrow-icon"},{default:A((()=>[f("›")])),_:1})])),_:1},8,["onClick"]),g(Y,{visible:p(M),loading:p(T),loadingMore:p(W),customers:p(b),managers:p(B),onClose:a[2]||(a[2]=e=>M.value=!1),onSelect:p(R),onFilter:p(G),onLoadMore:p(j)},null,8,["visible","loading","loadingMore","customers","managers","onSelect","onFilter","onLoadMore"]),g(n,{class:"flat-item"},{default:A((()=>[g(n,{class:"item-left"},{default:A((()=>[g(o,{src:w,class:"item-icon"})])),_:1}),g(x,{range:p(O),value:p(L)>-1?p(L):0,onChange:p(P),class:"full-width-picker",title:e.$t("todo.source")},{default:A((()=>[g(n,{class:h(["picker-display",{"placeholder-color":-1===p(L)}])},{default:A((()=>[f(C(p(L)>-1?p(O)[p(L)]:e.$t("todo.select_source")),1)])),_:1},8,["class"])])),_:1},8,["range","value","onChange","title"]),g(K,{class:"arrow-icon"},{default:A((()=>[f("›")])),_:1})])),_:1}),g(n,{class:"flat-item"},{default:A((()=>[g(n,{class:"item-left"},{default:A((()=>[g(o,{src:E,class:"item-icon"})])),_:1}),g(x,{range:p(c),value:z.value,onChange:p(u),class:"full-width-picker",title:e.$t("todo.assignee")},{default:A((()=>[g(n,{class:h(["picker-display",{"placeholder-color":!p(D)}])},{default:A((()=>[f(C(p(D)?p(D):e.$t("todo.assignee")),1)])),_:1},8,["class"])])),_:1},8,["range","value","onChange","title"]),g(K,{class:"arrow-icon"},{default:A((()=>[f("›")])),_:1})])),_:1}),g(y,{class:h({"theme-dark":t.value}),dueDate:p(l).dueDate,"onUpdate:dueDate":a[3]||(a[3]=e=>p(l).dueDate=e),notifyAt:p(l).notifyAt,"onUpdate:notifyAt":a[4]||(a[4]=e=>p(l).notifyAt=e)},null,8,["class","dueDate","notifyAt"]),g(n,{class:"footer-action"},{default:A((()=>[g(n,{style:{width:"35%"}},{default:A((()=>[g(V,{type:"secondary",label:e.$t("common.cancel_action"),onClick:p(r)},null,8,["label","onClick"])])),_:1}),g(n,{style:{width:"60%"}},{default:A((()=>[g(V,{type:"primary",label:p(s)?e.$t("common.saving"):e.$t("common.save"),loading:p(s),onClick:p(i)},null,8,["label","loading","onClick"])])),_:1})])),_:1})])),_:1}),g(q),g(F)])),_:1},8,["class"])}}}),[["__scopeId","data-v-d692e3d3"]]);export{z as default};
