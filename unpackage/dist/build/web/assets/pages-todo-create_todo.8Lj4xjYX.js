import{V as e,T as a,u as t,a as o,r as s,y as l,c as n,b as r,i as c,L as i,W as u,j as d,k as m,l as A,w as g,B as p,D as f,m as C,t as h,p as v,P as I,q as S,O as _,X as k}from"./index-BWEkXzoS.js";import{_ as w,T as y,a as D,b as E,c as U}from"./TodoDatePicker.Cdz22joM.js";import{T as b,s as M,i as T,v as N,j as R,k as L,l as O,c as P,m as B,A as x,e as q,G as V,f as F,_ as G}from"./GlobalNotification.snEFDVN_.js";import{u as W,C as Y}from"./useCustomerFilter.D2__S7vN.js";const j=e=>{if(!e)return 0;const a=e.replace(/-/g,"/"),t=new Date(a);return isNaN(t.getTime())?0:t.getTime()},K=()=>{const{t:d}=t(),m=o(),A=e=>e.toString().padStart(2,"0"),{customerList:g,loadingCustomer:p,loadingMore:f,fetchCustomers:C,loadMoreCustomers:h}=W(),v=s(!1),I=s({name:"",desc:"",customer:"",customerUid:"",assignee:"",dueDate:"",notifyAt:""});l((()=>I.value.dueDate),(e=>{})),l((()=>I.value.notifyAt),(e=>{}));const S=n((()=>[d("source.call"),d("source.customer"),d("source.conversation")])),_=[a.CALL,a.CUSTOMER,a.CONVERSATION],k=s(-1),w=s([]),y=s([]),D=s(-1),E=s(!1);s("");const U=n((()=>D.value>-1&&y.value.length>0?y.value[D.value]:""));return r((()=>{(async()=>{try{const e=await c();w.value=e,y.value=e.map((e=>e.UserName||d("common.unknown_member")))}catch(e){console.error("Lỗi lấy thành viên:",e),M(d("todo.error_load_member"))}})(),C({}),setTimeout((()=>{const e=(()=>{const e=new Date;return`${e.getFullYear()}-${A(e.getMonth()+1)}-${A(e.getDate())} ${A(e.getHours())}:${A(e.getMinutes())}:00`})();I.value.dueDate=e,I.value.notifyAt=e}),100)})),{loading:v,form:I,memberOptions:y,onMemberChange:e=>{const a=e.detail.value;D.value=a;const t=w.value[a];t&&(I.value.assignee=t.memberUID)},currentAssigneeName:U,showCustomerModal:E,loadingCustomer:p,customerList:g,openCustomerPopup:()=>{E.value=!0,0===g.value.length&&C({})},onCustomerSelect:e=>{if(I.value.customer=`${e.name} - ${e.phone}`,I.value.customerUid=e.uid,e.managerUid){const a=w.value.findIndex((a=>a.memberUID===e.managerUid));-1!==a&&(D.value=a,I.value.assignee=e.managerUid,console.log(`Đã tự động chọn quản lý: ${w.value[a].UserName}`))}E.value=!1},goBack:()=>i(),submitForm:async()=>{if(!I.value.name||!I.value.name.trim())return void T(d("todo.validate_name"));if(!N(I.value.dueDate,I.value.notifyAt))return void M(d("todo.msg_notify_must_be_before_due"));let t="CALL";k.value>=0&&(t=_[k.value]),v.value=!0,R(d("todo.upload_processing"));try{const{newContent:o,fileUrls:s}=await(async e=>{if(!e)return{newContent:"",fileUrls:[]};const a=/<img[^>]+src="([^">]+)"/g;let t;const o=[],s=[],l=[];for(;null!==(t=a.exec(e));){const e=t[1];if(!e.startsWith("http")&&!e.startsWith("https")){const a=B(e).then((a=>{s.push({oldSrc:e,newSrc:a}),l.push(a)})).catch((a=>{console.error(`Upload ảnh ${e} lỗi:`,a)}));o.push(a)}}o.length>0&&await Promise.all(o);let n=e;return s.forEach((e=>{n=n.split(e.oldSrc).join(e.newSrc)})),{newContent:n,fileUrls:l}})(I.value.desc);I.value.desc=o;const l=((t,o)=>(console.log("Check date values:",{dueDate:t.dueDate,notifyAt:t.notifyAt}),{title:t.name,description:t.desc||e.STRING,projectCode:o.projectCode,createdBy:o.uid,status:b.NEW,links:o.link||a.CALL,pluginType:e.PLUGIN_TYPE,customerCode:t.customerUid||e.CUSTOMER_CODE,assigneeId:t.assignee||e.ASSIGNEE_ID,groupId:e.GROUP_ID,transId:e.TRANS_ID,tagCodes:"test1",groupMemberUid:"test1",files:o.uploadedFiles||e.STRING,phone:e.PHONE_PLACEHOLDER,dueDate:j(t.dueDate),notificationReceivedAt:j(t.notifyAt)}))(I.value,{projectCode:m.projectCode,uid:m.uid,link:t,uploadedFiles:s.length>0?s[0]:""});console.log("Payload Submit:",l),await L(l),O(),P(d("todo.create_success")),u("refresh-todo-list",{type:"create"}),setTimeout((()=>{i()}),1500)}catch(o){O(),console.error("Create Error:",o);const e=(null==o?void 0:o.message)||("string"==typeof o?o:d("common.failed"));M(d("common.error_load")+": "+e)}finally{v.value=!1}},sourceOptions:S,sourceIndex:k,onSourceChange:e=>{k.value=parseInt(e.detail.value)},memberList:w,onCustomerFilter:e=>{C(e)},loadingMore:f,loadMoreCustomers:h}},z=G(d({__name:"create_todo",setup(e){const a=o(),t=n((()=>a.isDark)),{loading:s,form:l,goBack:r,submitForm:c,memberOptions:i,onMemberChange:u,currentAssigneeName:d,showCustomerModal:b,loadingCustomer:M,customerList:T,openCustomerPopup:N,onCustomerSelect:R,sourceOptions:L,sourceIndex:O,onSourceChange:P,memberList:B,onCustomerFilter:G,loadingMore:W,loadMoreCustomers:j}=K(),z=n((()=>{if(!l.value.assignee||!B.value.length)return 0;const e=B.value.findIndex((e=>e.memberUID===l.value.assignee));return-1!==e?e:0}));return(e,a)=>{const o=I,n=S,K=_,Q=k;return m(),A(n,{class:v(["container",{"theme-dark":t.value}])},{default:g((()=>[p(n,{class:"custom-header"},{default:g((()=>[p(n,{onClick:f(r),class:"back-btn"},{default:g((()=>[p(o,{src:w,class:"back-icon"})])),_:1},8,["onClick"]),p(K,{class:"header-title"},{default:g((()=>[C(h(e.$t("todo.create_page_title")),1)])),_:1}),p(n,{class:"header-right"})])),_:1}),p(n,{class:"content-body"},{default:g((()=>[p(n,{class:"flat-item title-input-group"},{default:g((()=>[p(n,{class:"item-left"},{default:g((()=>[p(o,{src:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADIAAAAyCAYAAAAeP4ixAAAACXBIWXMAAAsTAAALEwEAmpwYAAABhUlEQVR4nO3ZvUoDQRSG4VPYamHpZQj2Wot2Ymd0s987/hBIZ5lr0EuwtvECbCxsxNI7MI2VNiqCUQY2sMYkJjY5E+aFJZBsMQ9MTsKOWS43VZLWgCvgWdKrpFtg11IKaAAfwNfgJencUqjT6SxIuhuGqF07lkLNZnMZuB8DuTGvlWUpoAts/IWR9GIeAw6BXrXQzf77YzBP5hzRHvx8BObSUkKMwMRptmqpIeqYapo1LEUEsBVCWO+PZvOSpDAFol3d1zVP/RPRAzAvAaWkz2pxp1MgTsxLc4EIITQzwkMZkTpC0rF5KSO8NBcISUVGeEgZ4SRlhJOUEYkjgCPzkjLCSZoHBHCQER4qy3K/hpjo4Vm8P/6FNy+1Wq0l4C1pREzSdm2bHNpk22nkfTMLOKsdogxdpHtETNLDwInQj8UmgSiKYqX2hPwXJglELISwN+oYuD/F4mv8kTTPARfjDuclvcfRbN6T9Dhk8Q/VANgqimLRUgi4rjAXcZvF78ys15SzhPsGc13jc1wqjCcAAAAASUVORK5CYII=",class:"item-icon"})])),_:1}),p(Q,{class:"item-input title-textarea",modelValue:f(l).name,"onUpdate:modelValue":a[0]||(a[0]=e=>f(l).name=e),placeholder:e.$t("todo.enter_task_name"),maxlength:"256","auto-height":"","placeholder-class":"input-placeholder"},null,8,["modelValue","placeholder"]),p(K,{class:"char-count"},{default:g((()=>[C(h(e.$t("todo.char_count").replace("{current}",String(f(l).name?f(l).name.length:0)).replace("{max}","256")),1)])),_:1})])),_:1}),p(y,{modelValue:f(l).desc,"onUpdate:modelValue":a[1]||(a[1]=e=>f(l).desc=e),placeholder:e.$t("editor.placeholder")},null,8,["modelValue","placeholder"]),p(n,{class:"flat-item customer-item",onClick:f(N)},{default:g((()=>[p(n,{class:"item-left"},{default:g((()=>[p(o,{src:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADIAAAAyCAYAAAAeP4ixAAAACXBIWXMAAAsTAAALEwEAmpwYAAACUElEQVR4nO3ZMW/UMBQHcAshBpZeCwMSIHUAJGa+BfuxRsJ+f8t3SHRky9dAfALKqRPlO7SlwMjQgQFGKmiHqgxw1dO9q470TroktmOr/UteTsm7/OLYcRKlrnIJA+A2gDcAvgP4B2Dcov0BsGetfRoVYYy5B+Cg5cGP57VomArikzHmSVmW19vU7Pf7NwC84ppEtKtiI7TWa75q9ycYhpyqiIgvw+Hwlu//gFxeKlZPOOdW6+5PRCMAx9yIaMta+zAqpILYb4IAcDhnYB9aa+9GgbRFcGjSE7z/ez5wbgC25bfN4BAfCDm4Y5lWz8++c+6+1P0dFOILwSGiI67DNaNCfCI4RLQltba5tgz8DzLVjoJAZhFE9LEtQmo+IqKf8wa71vqBd0gIxDR2MsA3+TKTNqoivEAqiM8+79h10gqSCqIVJOTaKRrEJIZoBEkRURtSQewVRdFTCaQsy2syTv9m2xMcADcFcqJqzE67qfTENFrrx3JsP1TGiDW+QuRKeb0UAsCKShdxwG9nLmw0GAzuzIyJndQQzrnVWcTsCvm/AHiXPYLD6/3qs0BCiP2lEBwAX2VsDFSuCI4x5tn0JkNEz1WOiGkAbMi7WW5OdZSiKHq8kpAT+81au167SNeYoih6MvU3R3SNAbDiDTEPE2MCCIKIjQmKiIWJggiNiYoIhekE4RvTKcIXhhGyMO0OseA+M1Q5IppikkTUxSSNWBaTBWLBBPAiS0QFMxbMS/nStNPoeSKhnjn/SJNNTyx40uTH5l9E9JbfzlzY6CqXIGdeAVlOOaDiuAAAAABJRU5ErkJggg==",class:"item-icon"})])),_:1}),p(n,{class:v(["input-trigger",{placeholder:!f(l).customer}])},{default:g((()=>[C(h(f(l).customer||e.$t("todo.select_customer")),1)])),_:1},8,["class"]),p(K,{class:"arrow-icon"},{default:g((()=>[C("›")])),_:1})])),_:1},8,["onClick"]),p(Y,{visible:f(b),loading:f(M),loadingMore:f(W),customers:f(T),managers:f(B),onClose:a[2]||(a[2]=e=>b.value=!1),onSelect:f(R),onFilter:f(G),onLoadMore:f(j)},null,8,["visible","loading","loadingMore","customers","managers","onSelect","onFilter","onLoadMore"]),p(n,{class:"flat-item"},{default:g((()=>[p(n,{class:"item-left"},{default:g((()=>[p(o,{src:D,class:"item-icon"})])),_:1}),p(x,{range:f(L),value:f(O)>-1?f(O):0,onChange:f(P),class:"full-width-picker",title:e.$t("todo.source")},{default:g((()=>[p(n,{class:v(["picker-display",{"placeholder-color":-1===f(O)}])},{default:g((()=>[C(h(f(O)>-1?f(L)[f(O)]:e.$t("todo.select_source")),1)])),_:1},8,["class"])])),_:1},8,["range","value","onChange","title"]),p(K,{class:"arrow-icon"},{default:g((()=>[C("›")])),_:1})])),_:1}),p(n,{class:"flat-item"},{default:g((()=>[p(n,{class:"item-left"},{default:g((()=>[p(o,{src:E,class:"item-icon"})])),_:1}),p(x,{range:f(i),value:z.value,onChange:f(u),class:"full-width-picker",title:e.$t("todo.assignee")},{default:g((()=>[p(n,{class:v(["picker-display",{"placeholder-color":!f(d)}])},{default:g((()=>[C(h(f(d)?f(d):e.$t("todo.assignee")),1)])),_:1},8,["class"])])),_:1},8,["range","value","onChange","title"]),p(K,{class:"arrow-icon"},{default:g((()=>[C("›")])),_:1})])),_:1}),p(U,{class:v({"theme-dark":t.value}),dueDate:f(l).dueDate,"onUpdate:dueDate":a[3]||(a[3]=e=>f(l).dueDate=e),notifyAt:f(l).notifyAt,"onUpdate:notifyAt":a[4]||(a[4]=e=>f(l).notifyAt=e)},null,8,["class","dueDate","notifyAt"]),p(n,{class:"footer-action"},{default:g((()=>[p(n,{style:{width:"35%"}},{default:g((()=>[p(q,{type:"secondary",label:e.$t("common.cancel_action"),onClick:f(r)},null,8,["label","onClick"])])),_:1}),p(n,{style:{width:"60%"}},{default:g((()=>[p(q,{type:"primary",label:f(s)?e.$t("common.saving"):e.$t("common.save"),loading:f(s),onClick:f(c)},null,8,["label","loading","onClick"])])),_:1})])),_:1})])),_:1}),p(V),p(F)])),_:1},8,["class"])}}}),[["__scopeId","data-v-45bcb589"]]);export{z as default};
